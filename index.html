<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Avaloka Fitness AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA META -->
<meta name="theme-color" content="#020617">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
:root{
  --bg:#020617;--card:rgba(15,23,42,.6);--border:rgba(148,163,184,.15);
  --accent:#38bdf8;--good:#22c55e;--bad:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
header{padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.logo{font-weight:700}
select,button{
  background:var(--card);color:#e5e7eb;border:1px solid var(--border);
  border-radius:12px;padding:8px 14px
}
button{cursor:pointer}

.camera-wrap{position:relative;padding:10px}
video,canvas{width:100%;border-radius:22px}
canvas{position:absolute;top:10px;left:10px}
#overlay{position:absolute;inset:10px;border-radius:22px;pointer-events:none}
.good{box-shadow:0 0 40px rgba(34,197,94,.6);background:rgba(34,197,94,.08)}
.bad{box-shadow:0 0 40px rgba(239,68,68,.6);background:rgba(239,68,68,.08)}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;backdrop-filter:blur(12px)}
.card h2{margin:0;font-size:30px;color:var(--accent)}
.card p{margin-top:6px;font-size:13px;opacity:.8}

@keyframes pulse{0%{transform:scale(1)}40%{transform:scale(1.35)}100%{transform:scale(1)}}
.pulse{animation:pulse .35s ease-out;color:var(--good)}

.install{padding:0 14px 14px;display:none}
footer{text-align:center;padding-bottom:14px;font-size:12px;opacity:.5}
</style>
</head>

<body>

<header>
  <div class="logo">üèãÔ∏è Avaloka</div>
  <select id="mode">
    <option value="pushup">Push-ups</option>
    <option value="pullup">Pull-ups</option>
    <option value="chinup">Chin-ups</option>
    <option value="squat">Squats</option>
    <option value="plank">Plank</option>
  </select>
</header>

<div class="camera-wrap">
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>
  <div id="overlay"></div>
</div>

<div class="stats">
  <div class="card">
    <h2 id="count">0</h2>
    <p>Reps / Seconds</p>
  </div>
  <div class="card">
    <h2 id="status">Starting‚Ä¶</h2>
    <p>Status</p>
  </div>
</div>

<div class="install">
  <button id="installBtn">‚¨áÔ∏è Install Avaloka App</button>
</div>

<footer>Install once ‚Ä¢ Works offline ‚Ä¢ Powered by Avaloka AI</footer>

<script>
/* ================= PWA (MANIFEST + SW) ================= */
const manifest = {
  name: "Avaloka Fitness AI",
  short_name: "Avaloka",
  start_url: ".",
  display: "standalone",
  background_color: "#020617",
  theme_color: "#020617",
  icons: [{
    src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAF0lEQVR4Xu3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAwA8M7AABXw2JzQAAAABJRU5ErkJggg==",
    sizes: "192x192",
    type: "image/png"
  }]
};
const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement("link");
link.rel = "manifest"; link.href = manifestURL;
document.head.appendChild(link);

// Service Worker (offline)
if ("serviceWorker" in navigator) {
  const swCode = `
    self.addEventListener("install",e=>{
      e.waitUntil(caches.open("avaloka").then(c=>c.addAll(["./"])))
    });
    self.addEventListener("fetch",e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))
    });
  `;
  const swBlob = new Blob([swCode], {type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}

// Install prompt
let deferredPrompt;
const installUI=document.querySelector(".install");
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault(); deferredPrompt=e; installUI.style.display="block";
});
document.getElementById("installBtn").onclick=()=>{
  deferredPrompt.prompt(); deferredPrompt=null; installUI.style.display="none";
};

/* ================= FITNESS AI (ROCK SOLID) ================= */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const overlay=document.getElementById("overlay");
const countEl=document.getElementById("count");
const statusEl=document.getElementById("status");

let count=0,state="UP",lastRepTime=0,plankStart=null;
let angleBuf=[],prevY=null,stableFrames=0;
const MIN_REP_TIME=600, MIN_MOVE=0.04, STABLE_FRAMES=3;

// Back camera with fallback
(async ()=>{
  try{
    video.srcObject = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{exact:"environment"}}, audio:false
    });
  }catch{
    video.srcObject = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
  }
})();

function canCount(){const n=Date.now(); if(n-lastRepTime<MIN_REP_TIME)return false; lastRepTime=n; return true}
function smooth(v){angleBuf.push(v); if(angleBuf.length>5) angleBuf.shift(); return angleBuf.reduce((a,b)=>a+b,0)/angleBuf.length}
function moved(y){ if(prevY===null){prevY=y;return false} const d=Math.abs(y-prevY); prevY=y; return d>MIN_MOVE}
function good(){overlay.className="good"; setTimeout(()=>overlay.className="",200)}
function bad(){overlay.className="bad"}
function pulse(){countEl.classList.remove("pulse"); void countEl.offsetWidth; countEl.classList.add("pulse")}
function angle(a,b,c){
  const ab={x:a.x-b.x,y:a.y-b.y},cb={x:c.x-b.x,y:c.y-b.y};
  return Math.acos((ab.x*cb.x+ab.y*cb.y)/(Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y)))*180/Math.PI;
}

const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({modelComplexity:1,smoothLandmarks:true,minDetectionConfidence:.5,minTrackingConfidence:.5});

pose.onResults(r=>{
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!r.poseLandmarks)return;

  drawConnectors(ctx,r.poseLandmarks,POSE_CONNECTIONS,{color:"#22c55e",lineWidth:4});
  drawLandmarks(ctx,r.poseLandmarks,{color:"#38bdf8",lineWidth:2});

  const lm=r.poseLandmarks;
  const sh=lm[11],el=lm[13],wr=lm[15],hip=lm[23],kn=lm[25],an=lm[27],nose=lm[0];
  const elbowA=smooth(angle(sh,el,wr));
  const kneeA=smooth(angle(hip,kn,an));
  const bodyA=angle(sh,hip,an);
  const mode=document.getElementById("mode").value;
  statusEl.innerText="Tracking";

  if(mode==="pushup"){
    if(bodyA<160){bad();statusEl.innerText="Straighten body";return}
    if(elbowA<90){state="DOWN"; stableFrames=0}
    if(elbowA>165 && state==="DOWN" && moved(sh.y)){
      if(++stableFrames>=STABLE_FRAMES && canCount()){
        count++; pulse(); good(); state="UP"; stableFrames=0;
      }
    }
  }

  if(mode==="pullup"||mode==="chinup"){
    const chinUp=nose.y<wr.y;
    if(elbowA>155){state="DOWN"; stableFrames=0}
    if(elbowA<65 && chinUp && state==="DOWN" && moved(nose.y)){
      if(++stableFrames>=STABLE_FRAMES && canCount()){
        count++; pulse(); good(); state="UP"; stableFrames=0;
      }
    }
    if(!chinUp) bad();
  }

  if(mode==="squat"){
    if(kneeA<95){state="DOWN"; stableFrames=0}
    if(kneeA>165 && state==="DOWN" && moved(hip.y)){
      if(++stableFrames>=STABLE_FRAMES && canCount()){
        count++; pulse(); good(); state="UP"; stableFrames=0;
      }
    }
  }

  if(mode==="plank"){
    if(bodyA>165){
      if(!plankStart) plankStart=Date.now();
      countEl.innerText=Math.floor((Date.now()-plankStart)/1000);
      good(); return;
    }else{
      plankStart=null; bad(); statusEl.innerText="Fix posture"; return;
    }
  }

  countEl.innerText=count;
});

new Camera(video,{onFrame:async()=>await pose.send({image:video}),width:640,height:480}).start();
</script>

</body>
</html>
